generator client {
  provider = "prisma-client-js"
}

generator zod {
  provider = "zod-prisma-types"
  output   = "./generated/zod"
}

datasource db {
  provider = "mongodb"
  url      = env("MONGODB_URI")
}

// Enums
enum SubscriptionPlan {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

enum UserRole {
  USER
  MANAGER
  ADMIN
}


enum DocumentType {
  FACTURE
  CONTRAT
  CARTE_IDENTITE
  PASSEPORT
  JUSTIFICATIF_DOMICILE
  ACTE_NAISSANCE
  ACTE_MARIAGE
  DIPLOME
  ATTESTATION_TRAVAIL
  FICHE_PAIE
  RELEVE_BANCAIRE
  ASSURANCE
  PERMIS_CONDUIRE
  CARTE_VITALE
  AUTRE
}

enum DocumentStatut {
  VERIFIE
  EN_ATTENTE
  EXPIRE
  REFUSE
}

enum NotificationType {
  EXPIRATION
  RAPPEL
  INFO
  ALERTE
}

enum NotificationPriorite {
  BASSE
  NORMALE
  HAUTE
}

enum ExtractionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum DemarcheStatut {
  EN_COURS
  COMPLETE
  ABANDONNEE
}

enum DemarcheCategorie {
  ADMINISTRATIF
  FINANCIER
  JURIDIQUE
  PERSONNEL
  AUTRE
}

model User {
  id                     String                  @id @default(auto()) @map("_id") @db.ObjectId
  // NextAuth standard fields (added)
  name                   String?
  image                  String?
  email                  String?                 @unique
  emailVerified          DateTime?
  googleId               String?                 @unique
  password               String?
  plan                   SubscriptionPlan        @default(FREE)
  role                   UserRole                @default(USER)
  onboardingCompleted    Boolean                 @default(false)
  dateInscription        DateTime                @default(now())
  preferences            UserPreferences?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  documents              Document[]
  dossiers               Dossier[]
  demarchesUtilisateur   DemarcheUtilisateur[]
  createdDemarches       ModeleDemarche[]        @relation("CreatedDemarches")
  notifications          Notification[]
  // Relations required by NextAuth (added)
  accounts               Account[]
  sessions               Session[]
  @@map("users")
}

type UserPreferences {
  notifications Boolean @default(true)
  language      String  @default("fr")
}

model Document {
  id                String              @id @default(auto()) @map("_id") @db.ObjectId
  idProprietaire    String              @db.ObjectId
  nomFichier        String
  urlStockage       String?
  storageId         String?
  type              DocumentType
  statut            DocumentStatut      @default(EN_ATTENTE)
  tags              String[]
  dateUpload        DateTime            @default(now())
  dateExpiration    DateTime?
  size              Int
  metadata          Json?
  extractionStatus  ExtractionStatus    @default(PENDING)
  extractionError   String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  proprietaire      User                @relation(fields: [idProprietaire], references: [id], onDelete: Cascade)
  dossiers          Dossier[]           @relation(fields: [dossierIds], references: [id])
  dossierIds        String[]            @db.ObjectId
  notifications     Notification[]
  @@index([idProprietaire])
  @@index([type])
  @@index([statut])
  @@index([tags])
  @@index([idProprietaire, type])
  @@index([idProprietaire, statut])
  @@index([idProprietaire, tags])
  @@map("documents")
}

model Dossier {
  id             String     @id @default(auto()) @map("_id") @db.ObjectId
  idProprietaire String     @db.ObjectId
  nom            String
  idsDocuments   String[]   @db.ObjectId
  couleur        String     @default("#3B82F6")
  icone          String     @default("folder")
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  proprietaire   User       @relation(fields: [idProprietaire], references: [id], onDelete: Cascade)
  documents      Document[] @relation(fields: [idsDocuments], references: [id])
  @@index([idProprietaire])
  @@map("dossiers")
}

model ModeleDemarche {
  id                    String                  @id @default(auto()) @map("_id") @db.ObjectId
  titre                 String                  @unique
  description           String?
  typesDocumentsRequis  String[]
  categorie             DemarcheCategorie       @default(AUTRE)
  actif                 Boolean                 @default(true)
  ordre                 Int                     @default(0)
  createdById           String?                 @db.ObjectId
  createdBy             User?                   @relation("CreatedDemarches", fields: [createdById], references: [id])
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  demarchesUtilisateur  DemarcheUtilisateur[]
  @@index([actif, ordre])
  @@map("modele_demarches")
}

model DemarcheUtilisateur {
  id                String             @id @default(auto()) @map("_id") @db.ObjectId
  idUtilisateur     String             @db.ObjectId
  idModele          String             @db.ObjectId
  complete          Boolean            @default(false)
  dateDebut         DateTime           @default(now())
  dateCompletion    DateTime?
  statut            DemarcheStatut     @default(EN_COURS)
  notes             String?
  documentsAssocies Json?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  utilisateur       User               @relation(fields: [idUtilisateur], references: [id], onDelete: Cascade)
  modele            ModeleDemarche     @relation(fields: [idModele], references: [id], onDelete: Cascade)
  @@index([idUtilisateur])
  @@index([complete])
  @@index([statut])
  @@index([idUtilisateur, statut])
  @@index([idUtilisateur, complete])
  @@map("demarche_utilisateurs")
}

model Notification {
  id             String                @id @default(auto()) @map("_id") @db.ObjectId
  idUser         String                @db.ObjectId
  type           NotificationType
  message        String
  idDocumentLie  String?               @db.ObjectId
  lu             Boolean               @default(false)
  dateCreation   DateTime              @default(now())
  priorite       NotificationPriorite  @default(NORMALE)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  user           User                  @relation(fields: [idUser], references: [id], onDelete: Cascade)
  documentLie    Document?             @relation(fields: [idDocumentLie], references: [id], onDelete: SetNull)
  @@index([idUser])
  @@index([type])
  @@index([lu])
  @@index([dateCreation])
  @@index([idUser, lu])
  @@index([idUser, dateCreation])
  @@index([idUser, type, lu])
  @@map("notifications")
}

// NextAuth models for Prisma Adapter (MongoDB)

model Account {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  userId            String   @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?  @db.String
  access_token      String?  @db.String
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.String
  session_state     String?
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Tag {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tags")
}
